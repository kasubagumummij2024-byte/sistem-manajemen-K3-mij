<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulir Sistem Manajemen K3 - Madrasah Istiqlal Jakarta</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        .site-header {
            background-color: var(--bg-card, #FFFFFF);
            border-bottom: 1px solid var(--border-color, #DEE2E6);
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .header-container {
            max-width: 900px; 
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo-group-left img { height: 50px; width: auto; }
        .logo-group-right { display: flex; align-items: center; gap: 1.5rem; }
        .logo-group-right img { height: 32px; width: auto; }
        .accreditation-logo {
            filter: grayscale(100%); opacity: 0.6; transition: all 0.3s ease;
        }
        .accreditation-logo:hover { filter: grayscale(0%); opacity: 1; }
        
        #dashboard-container {
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px dashed var(--border-color, #DEE2E6);
        }
        .rekap-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        /* --- TAMBAHAN STYLE UNTUK DETAIL REVIEW (Solusi No. 2) --- */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .detail-table th, .detail-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .detail-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .detail-header {
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        /* --- AKHIR TAMBAHAN STYLE --- */

        @media (max-width: 768px) {
            .logo-group-right { display: none; }
            .logo-group-left img { height: 40px; }
            .header-container { max-width: 100%; padding: 0 0.5rem; }
            .rekap-controls { flex-wrap: wrap; }
            /* Agar tabel bisa di-scroll di HP */
            .table-responsive { overflow-x: auto; } 
        }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-container">
            <div class="logo-group-left">
                <img src="/images/logo-mij.png" alt="Logo MIJ" 
                     onerror="this.src='https://placehold.co/150x50/f8fafc/0f172a?text=Logo+MIJ'; this.onerror=null;">
            </div>
            <div class="logo-group-right">
                <img src="/images/logo-cambridge.png" alt="Cambridge" class="accreditation-logo" title="Cambridge International School">
                <img src="/images/logo-iso.png" alt="ISO 9001" class="accreditation-logo" title="Quality Approved ISO 9001">
                <img src="/images/logo-dgi.png" alt="DGI Cert" class="accreditation-logo" title="DGI Cert ISO 21001:2018">
            </div>
        </div>
    </header>

    <div class="page-container">
        <header class="page-header">
            <h1>Formulir Sistem Manajemen K3</h1>
            <h2>Madrasah Istiqlal Jakarta</h2>
        </header>

        <div id="main-content" class="hidden">
            
            <div id="dashboard-container">
                <section class="auth-section logged-in">
                    <div id="user-info">
                        <span id="user-email">email@example.com</span> <button id="logout-button" class="btn btn-secondary btn-sm">Logout</button>
                    </div>
                </section>

                <section id="admin-area" class="admin-area hidden section-card">
                    <h3>Rekap Laporan</h3> 
                    <div class="rekap-controls">
                        <select id="rekap-bulan"></select>
                        <select id="rekap-tahun"></select>
                        <button id="download-rekap-pdf-btn" class="btn btn-primary">Download PDF</button>
                        <button id="download-rekap-excel-btn" class="btn btn-secondary">Download Excel</button>
                    </div>
                    <div id="rekap-status"></div>
                </section>

                <section id="review-section" class="review-area section-card"> <h3 id="review-title">Status Laporan Saya / Untuk Direview</h3> <div id="review-list-container">
                        <ul id="review-list"><p>Memuat laporan...</p></ul>
                    </div>
                    <div id="review-detail" class="hidden">
                        <h4>Detail Laporan <span id="review-report-id"></span></h4>
                        <div id="review-report-content" class="table-responsive"></div>
                        <div id="review-actions">
                            <label for="review-notes">Catatan:</label>
                            <textarea id="review-notes" rows="3"></textarea>
                            <div class="action-buttons"></div>
                        </div>
                        <button id="back-to-list-btn" class="btn btn-secondary">Kembali</button>
                    </div>
                </section>

                <div class="toggle-section">
                    <button id="toggle-public-archive-btn" class="btn btn-secondary">Lihat Arsip Laporan Publik</button>
                </div>

                <section id="public-view-section" class="public-area section-card hidden">
                    <h3>Arsip Laporan Publik (Approved)</h3>
                    <div class="search-controls">
                        <input type="text" id="search-term" placeholder="Cari Kegiatan, Pelaksana, Lokasi...">
                        <button id="search-btn" class="btn btn-primary">Cari</button>
                    </div>
                    <div id="public-list-container">
                        <p id="public-list-status">Memuat data...</p>
                        <ul id="public-list"></ul>
                    </div>
                </section>
            </div> 

            <form id="k3-form">
                <fieldset class="section-card">
                    <legend id="form-title">1. Informasi Kegiatan</legend>
                    <div class="form-grid">
                        <div><label for="pelaksana">Pelaksana / PJ</label><input type="text" id="pelaksana" name="pelaksana" required></div>
                        <div><label for="satker">Satker / Satdik</label><select id="satker" name="satker" required><option value="">Pilih...</option><option value="Kelompok Bermain">Kelompok Bermain</option><option value="Raudhatul Athfal">Raudhatul Athfal</option><option value="Madrasah Ibtidaiyah">Madrasah Ibtidaiyah</option><option value="Madrasah Tsanawiyah">Madrasah Tsanawiyah</option><option value="Madrasah Aliyah">Madrasah Aliyah</option><option value="Istiqlal Boarding School">Istiqlal Boarding School</option><option value="Bag. Penjamin Mutu">Bag. Penjamin Mutu</option><option value="Bag. KHK">Bag. KHK</option><option value="Bag. TU & Umum">Bag. TU & Umum</option></select></div>
                    </div>
                    <div><label for="namaKegiatan">Nama Kegiatan</label><input type="text" id="namaKegiatan" name="namaKegiatan" required></div>
                    <div><label for="lokasiKegiatan">Lokasi Kegiatan / Survei</label><input type="text" id="lokasiKegiatan" name="lokasiKegiatan" required></div>
                    <div class="form-grid">
                        <div><label for="tanggalPenilaian">Tgl Penilaian</label><input type="date" id="tanggalPenilaian" name="tanggalPenilaian" required></div>
                        <div><label for="tanggalKegiatan">Tgl Kegiatan</label><input type="date" id="tanggalKegiatan" name="tanggalKegiatan" required></div>
                    </div>
                </fieldset>

                <fieldset class="section-card">
                    <legend>2. Identifikasi Bahaya</legend>
                    <div id="bahaya-list" class="card-list-container"></div>
                    <button type="button" id="add-bahaya" class="btn btn-secondary btn-add">+ Tambah Item Bahaya</button>
                </fieldset>

                <fieldset class="section-card">
                    <legend>3. Inspeksi Rambu K3</legend>
                    <div id="rambu-list" class="card-list-container"></div>
                    <button type="button" id="add-rambu" class="btn btn-secondary btn-add">+ Tambah Item Rambu</button>
                </fieldset>

                <div class="submit-area">
                    <button type="submit" id="submit-button" class="btn btn-primary btn-submit">Submit Laporan</button>
                    <div id="status-message"></div>
                </div>
            </form>
        </div> 
        
        <div id="auth-content" class="hidden">
            <section class="section-card auth-card">
                <h3 id="auth-card-title">Login</h3> <div id="auth-status-message"></div>

                <form id="login-form">
                    <label for="login-email">Email</label> <input type="email" id="login-email" required placeholder="email@example.com">
                    <label for="login-password">Password</label> <input type="password" id="login-password" required placeholder="********">
                    <button type="submit" class="btn btn-primary btn-fullwidth">Login</button>
                    <div class="auth-links">
                        <a href="#" id="show-register">Belum punya akun? Registrasi</a>
                        <a href="#" id="show-reset">Lupa Password?</a>
                    </div>
                </form>

                <form id="register-form" class="hidden">
                    <label for="register-email">Email</label>
                    <input type="email" id="register-email" required placeholder="email@example.com">
                    <label for="register-password">Password</label>
                    <input type="password" id="register-password" required placeholder="Minimal 6 karakter">
                    <label for="register-confirm-password">Konfirmasi Password</label>
                    <input type="password" id="register-confirm-password" required placeholder="Ulangi password">
                    <button type="submit" class="btn btn-primary btn-fullwidth">Registrasi</button>
                    <div class="auth-links">
                        <a href="#" id="show-login-from-register">Sudah punya akun? Login</a>
                    </div>
                </form>

                <form id="reset-form" class="hidden">
                    <p>Masukkan email Anda untuk menerima link reset password.</p>
                    <label for="reset-email">Email</label>
                    <input type="email" id="reset-email" required placeholder="email@example.com">
                    <button type="submit" class="btn btn-primary btn-fullwidth">Kirim Link Reset</button>
                    <div class="auth-links">
                        <a href="#" id="show-login-from-reset">Kembali ke Login</a>
                    </div>
                </form>
            </section>
        </div> 
    </div> 
    
    <template id="bahaya-template">
        <div class="form-card">
            <div class="card-header">
                <h4>Item Bahaya</h4>
                <button type="button" class="btn-remove" onclick="removeRow(this.closest('.form-card'))">Hapus</button>
            </div>
            <div class="card-content">
                <label>Identifikasi Bahaya</label>
                <textarea name="identifikasi" rows="3" required></textarea>
                <label>Risiko</label>
                <textarea name="risiko" rows="3" required></textarea>
                <div class="form-grid">
                    <div><label>Peluang (A-E)</label><select name="peluang" required><option value="">Pilih...</option><option value="A">A: Hampir pasti</option><option value="B">B: Cenderung</option><option value="C">C: Mungkin</option><option value="D">D: Kecil kemungkinan</option><option value="E">E: Sangat jarang</option></select></div>
                    <div><label>Akibat (1-5)</label><select name="akibat" required><option value="">Pilih...</option><option value="1">1: Tdk Cedera / Tdk Gangguan Kesehatan</option><option value="2">2: Cedera Ringan / Gangguan < 7 Hari</option><option value="3">3: Hilang Hari Kerja / Gangguan 1-4 mg</option><option value="4">4: Cacat / Gangguan 1-3 bln</option><option value="5">5: Fatality / Gangguan Jangka Panjang</option></select></div>
                </div>
                <label>Tingkat Risiko</label>
                <output name="tingkatRisiko" class="risk-output">-</output>
                <label>Pengendalian Risiko</label>
                <textarea name="pengendalian" rows="3" required></textarea>
            </div>
        </div>
    </template>

    <template id="rambu-template">
        <div class="form-card">
             <div class="card-header">
                <h4>Item Rambu</h4>
                <button type="button" class="btn-remove" onclick="removeRow(this.closest('.form-card'))">Hapus</button>
             </div>
             <div class="card-content">
                <div class="form-grid">
                    <div><label>Nama Rambu</label><input type="text" name="namaRambu" required></div>
                    <div><label>Lokasi</label><input type="text" name="lokasi" required></div>
                </div>
                <label>Jenis Rambu</label>
                <select name="jenisRambu" required><option value="">Pilih...</option><option value="Tempel">Tempel</option><option value="Gantung">Gantung</option><option value="Berdiri">Berdiri</option></select>

                <fieldset class="inner-fieldset">
                    <legend>Kondisi: Jelas Terbaca</legend>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="jelas_a"> Tulisan Utuh</label>
                        <label><input type="checkbox" name="jelas_b"> Tidak Pudar</label>
                        <label><input type="checkbox" name="jelas_c"> Bisa Dilihat</label>
                    </div>
                </fieldset>
                <fieldset class="inner-fieldset">
                    <legend>Kondisi: Posisi Rambu</legend>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="posisi_a"> Tepat Lokasi</label>
                        <label><input type="checkbox" name="posisi_b"> Tidak Bergeser</label>
                        <label><input type="checkbox" name="posisi_c"> Tidak Hilang/Jatuh</label>
                    </div>
                </fieldset>
                <fieldset class="inner-fieldset">
                    <legend>Kondisi: Kebersihan</legend>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="bersih_a"> Bersih</label>
                        <label><input type="checkbox" name="bersih_b"> Tidak Berdebu</label>
                        <label><input type="checkbox" name="bersih_c"> Tidak Berkarat</label>
                    </div>
                </fieldset>

                <div class="form-grid">
                    <div><label>Total Skor</label><output name="totalSkor" class="score-output">0</output></div>
                    <div><label>Hasil</label><output name="hasil" class="result-output">-</output></div>
                </div>
                <label>Tindakan Perbaikan</label>
                <textarea name="tindakanPerbaikan" rows="3"></textarea>
             </div>
        </div>
    </template>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="app.js"></script>
</body>
</html>
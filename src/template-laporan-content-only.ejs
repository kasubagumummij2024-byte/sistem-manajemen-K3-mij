<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Konten Laporan K3 - <%= data.namaKegiatan %></title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 9pt; line-height: 1.3; color: #333; margin: 0; padding: 0; }
        
        .page-container {
            width: 100%;
            padding: 0 25px; /* Sesuaikan dengan margin Puppeteer di index.js */
            box-sizing: border-box;
        }

        .header-table {
            font-family: Arial, sans-serif; 
            width: 100%; 
            margin: 0;
            padding-top: 0;
            box-sizing: border-box; 
            border-collapse: collapse;
            margin-bottom: 10px; 
        }
        .header-table .logo-cell { width: 90px; padding: 5px; border: 1px solid #000; vertical-align: middle; text-align: center; }
        .header-table .center-cell { border-top: 1px solid #000; border-bottom: 1px solid #000; vertical-align: middle; text-align: center; padding: 5px 0; }
        .header-table .right-cell { width: 180px; padding: 5px 10px; border: 1px solid #000; vertical-align: top; text-align: right; font-size: 10pt; font-weight: bold; }
        .header-table .title-cell { padding: 10px; border: 1px solid #000; text-align: center; font-size: 12pt; font-weight: bold; }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            margin-bottom: 1rem;
            border: 1px solid #999;
            box-sizing: border-box;
            page-break-inside: avoid;
        }
        .info-grid-item { display: flex; border-bottom: 1px solid #999; }
        .info-grid-item:nth-child(2n) { border-left: 1px solid #999; }
        .info-grid-item:nth-last-child(1), 
        .info-grid-item:nth-last-child(2) { border-bottom: none; }
        .info-grid-item.full-width { grid-column: span 2; }
        .info-grid-label {
            font-weight: bold; width: 130px; flex-shrink: 0;
            padding: 5px 8px; background-color: #f4f4f4;
            border-right: 1px solid #999; box-sizing: border-box;
        }
        .info-grid-value { flex-grow: 1; padding: 5px 8px; box-sizing: border-box; }
        .info-grid-value .status { font-size: 9pt; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
        .data-table th, .data-table td { border: 1px solid #333; padding: 5px 7px; text-align: left; vertical-align: top; word-wrap: break-word; font-size: 8pt; }
        .data-table th { background-color: #e0e0e0; font-weight: bold; }
        .data-table .col-bahaya { width: 15%; } .data-table .col-risiko { width: 15%; } .data-table .col-peluang { width: 5%; text-align: center; } .data-table .col-akibat { width: 5%; text-align: center; } .data-table .col-tingkat { width: 8%; text-align: center; } .data-table .col-pengendalian { width: 32%; }
        .data-table .col-rambu { width: 15%; } .data-table .col-lokasi { width: 15%; } .data-table .col-jenis { width: 10%; } .data-table .col-kondisi { width: 15%; font-size: 7pt; line-height: 1.2;} .data-table .col-skor { width: 6%; text-align: center; } .data-table .col-hasil { width: 8%; text-align: center; } .data-table .col-tindakan { width: 16%; }
        .key-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 7pt; line-height: 1.2; border: 1px solid #aaa; page-break-inside: avoid; }
        .key-table th, .key-table td { border: 1px solid #aaa; padding: 3px 5px; text-align: left; vertical-align: top; }
        .key-table th { background-color: #f0f0f0; font-weight: bold; }
        
        .final-approval-section {
            margin-top: 1.5rem;
            page-break-inside: avoid;
            width: 100%;
        }
        .approval-info { margin-top: 1.5rem; border: 1px dashed #aaa; padding: 10px; font-size: 8pt; background-color: #f9f9f9; page-break-inside: avoid; }
        .approval-info p { margin: 2px 0; }
        .status { display: inline-block; font-weight: bold; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 8pt; text-transform: uppercase; border: 1px solid;}
        .status-Submitted { background-color: #fff9c4; color: #795548; border-color: #fff176;}
        .status-Reviewed_K3 { background-color: #c8e6c9; color: #1b5e20; border-color: #a5d6a7;}
        .status-Approved_TU { background-color: #a5d6a7; color: #1b5e20; border-color: #81c784;}
        .status-Rejected_K3, .status-Rejected_TU { background-color: #ffcdd2; color: #c62828; border-color: #ef9a9a;}
        .signature-block { margin-top: 1rem; width: 100%; display: table; table-layout: fixed; margin-bottom: 5px; page-break-inside: avoid; }
        .signature-col { display: table-cell; text-align: center; width: 33.3%; padding: 0 .5rem; vertical-align: bottom; }
        .signature-col p { margin: 0; padding: 0; font-size: 9pt; }
        .signature-box { height: 50px; margin: .3rem 0; border-bottom: 1px solid #999; }
        .signature-name { font-weight: bold; text-decoration: underline; }
        .approval-note { margin-top: 5px; font-size: 7pt; color: #555; text-align: left; page-break-inside: avoid; }
    </style>
</head>
<body>

    <div class="page-container">
        
        <table class="header-table">
            <tr>
                <td class="logo-cell">
                    <img src="<%= logoDataUrl %>" style="width: 70px; height: auto;">
                </td>
                <td class="center-cell">
                    <div style="font-size: 16pt; font-weight: bold; color: #000; margin: 0;">MADRASAH ISTIQLAL JAKARTA</div>
                    <div style="font-size: 11pt; font-weight: normal; color: #333; margin: 0;">Masjid Istiqlal, Taman Wijaya Kusuma Jakarta Pusat</div>
                </td>
                <td class="right-cell">
                    No. 094/F/BU/01/03/2023
                </td>
            </tr>
            <tr>
                <td colspan="3" class="title-cell">
                    Formulir Identifikasi Bahaya, Penilaian dan Pengendalian Resiko K3
                </td>
            </tr>
        </table>

        <div class="info-grid">
            <div class="info-grid-item"><div class="info-grid-label">Pelaksana / PJ</div><div class="info-grid-value"><%= data.pelaksana || '-' %></div></div>
            <div class="info-grid-item"><div class="info-grid-label">Satker / Satdik</div><div class="info-grid-value"><%= data.satker || '-' %></div></div>
            <div class="info-grid-item"><div class="info-grid-label">Nama Kegiatan</div><div class="info-grid-value"><%= data.namaKegiatan || '-' %></div></div>
            <div class="info-grid-item"><div class="info-grid-label">Lokasi Kegiatan</div><div class="info-grid-value"><%= data.lokasiKegiatan || '-' %></div></div>
            <div class="info-grid-item"><div class="info-grid-label">Tgl Penilaian</div><div class="info-grid-value"><%= formatDate(data.tanggalPenilaian) %></div></div>
            <div class="info-grid-item"><div class="info-grid-label">Tgl Rencana</div><div class="info-grid-value"><%= formatDate(data.tanggalKegiatan) %></div></div>
            <div class="info-grid-item full-width"><div class="info-grid-label" style="width: 130px; border-right: 1px solid #999;">Status Laporan</div><div class="info-grid-value"><span class="status status-<%= data.statusLaporan %>"><%= data.statusLaporan ? data.statusLaporan.replace(/_/g,' ') : 'N/A' %></span></div></div>
        </div>

        <table class="data-table">
            <thead><tr><th class="col-bahaya">Identifikasi Bahaya</th><th class="col-risiko">Risiko</th><th class="col-peluang">Peluang</th><th class="col-akibat">Akibat</th><th class="col-tingkat">Tingkat Risiko</th><th class="col-pengendalian">Pengendalian Risiko</th></tr></thead>
            <tbody>
                <% if (data.daftarBahaya && data.daftarBahaya.length > 0) { %>
                    <% data.daftarBahaya.forEach(item => { %>
                        <tr><td><%= item.identifikasi %></td><td><%= item.risiko %></td><td style="text-align: center;"><%= item.peluang %></td><td style="text-align: center;"><%= item.akibat %></td><td style="text-align: center; font-weight: bold;"><%= item.tingkatRisiko %></td><td><%= item.pengendalian %></td></tr>
                    <% }); %>
                <% } else { %>
                    <tr><td colspan="6" style="text-align: center;">- Tidak ada data -</td></tr>
                <% } %>
            </tbody>
        </table>
        <table class="key-table">
            <tr><th colspan="2">Peluang</th><th colspan="5">Akibat</th><th>Nilai Tingkat Resiko</th><th>Penjelasan Peluang</th><th colspan="2">Penjelasan Akibat</th></tr>
            <tr><td></td><td></td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td></td><td></td><td>Keselamatan Kerja</td><td>Kesehatan Kerja</td></tr>
            <tr><th>A</th><td>Hampir pasti</td><td>H</td><td>H</td><td>E</td><td>E</td><td>E</td><td>E: Extreme Risk</td><td>A: Hampir pasti</td><td>1: Tdk Cedera...</td><td>1: Tdk potensi...</td></tr>
            <tr><th>B</th><td>Cenderung</td><td>M</td><td>H</td><td>H</td><td>E</td><td>E</td><td>H: High Risk</td><td>B: Cenderung</td><td>2: Cedera Ringan...</td><td>2: Gangguan < 7 hr...</td></tr>
            <tr><th>C</th><td>Mungkin</td><td>L</td><td>M</td><td>H</td><td>E</td><td>E</td><td>M: Moderate Risk</td><td>C: Mungkin</td><td>3: Hilang Hari...</td><td>3: Gangguan 1-4 mg...</td></tr>
            <tr><th>D</th><td>Kecil kemungkinan</td><td>L</td><td>L</td><td>M</td><td>H</td><td>E</td><td>L: Low Risk</td><td>D: Kecil kemungkinan</td><td>4: Cacat...</td><td>4: Gangguan 1-3 bln...</td></tr>
            <tr><th>E</th><td>Sangat jarang</td><td>L</td><td>L</td><td>M</td><td>H</td><td>H</td><td></td><td>E: Sangat jarang</td><td>5: Fatality...</td><td>5: Gangguan >>...</td></tr>
        </table>
        
        <div class="final-approval-section">
            <div class="approval-info">
                <p><strong>Status Approval:</strong> <span class="status status-<%= data.statusLaporan %>"><%= data.statusLaporan ? data.statusLaporan.replace(/_/g,' ') : 'N/A' %></span></p>
                <% if (data.diperiksaOlehK3_nama) { %><p><strong>Diperiksa Ketua Tim K3:</strong> <%= data.diperiksaOlehK3_nama %> (<%= formatDate(data.tanggalDiperiksaK3) %>)</p><% if (data.catatanK3) { %><p><em>Catatan K3:</em> <%= data.catatanK3 %></p><% } %><% } %>
                <% if (data.disetujuiOlehTU_nama) { %><p><strong>Disetujui Kabag TU & Umum:</strong> <%= data.disetujuiOlehTU_nama %> (<%= formatDate(data.tanggalDisetujuiTU) %>)</p><% if (data.catatanTU) { %><p><em>Catatan TU:</em> <%= data.catatanTU %></p><% } %><% } %>
            </div>
            <div class="signature-block">
                <div class="signature-col"><p>Pelaksana / PJ Kegiatan</p><div class="signature-box"></div><p class="signature-name">( <%= data.pelaksana %> )</p></div>
                <div class="signature-col"><p>Diperiksa</p><div class="signature-box"></div><p class="signature-name">( Ketua Tim K3 )</p></div>
                <div class="signature-col"><p>Disetujui</p><div class="signature-box"></div><p class="signature-name">( Kabag TU & Umum )</p></div>
            </div>
            <% if (data.statusLaporan === 'Approved_TU') { %>
                <div class="approval-note">
                    Dokumen ini dianggap sah tanpa memerlukan tanda tangan fisik lebih lanjut setelah memperoleh persetujuan dari Kepala Bagian Tata Usaha dan Umum (Kabag TU & Umum).
                </div>
            <% } %>
        </div> 
        </div> <% if (data.inspeksiRambu && data.inspeksiRambu.length > 0) { %>
        <div style="page-break-before: always;"></div>
        
        <div class="page-container">
            
            <table class="header-table">
                <tr>
                    <td class="logo-cell">
                        <img src="<%= logoDataUrl %>" style="width: 70px; height: auto;">
                    </td>
                    <td class="center-cell">
                        <div style="font-size: 16pt; font-weight: bold; color: #000; margin: 0;">MADRASAH ISTIQLAL JAKARTA</div>
                        <div style="font-size: 11pt; font-weight: normal; color: #333; margin: 0;">Masjid Istiqlal, Taman Wijaya Kusuma Jakarta Pusat</div>
                    </td>
                    <td class="right-cell">
                        No. 095/F/BU/00/09/2022
                    </td>
                </tr>
                <tr>
                    <td colspan="3" class="title-cell">
                        Formulir Inspeksi Rambu K3
                    </td>
                </tr>
            </table>

            <table class="data-table">
                <thead><tr><th class="col-rambu">Nama Rambu</th><th class="col-lokasi">Lokasi</th><th class="col-jenis">Jenis</th><th class="col-kondisi">Kondisi Jelas</th><th class="col-kondisi">Kondisi Posisi</th><th class="col-kondisi">Kondisi Bersih</th><th class="col-skor">Total Skor</th><th class="col-hasil">Hasil</th><th class="col-tindakan">Tindakan</th></tr></thead>
                <tbody>
                    <% data.inspeksiRambu.forEach(item => { %>
                        <tr><td><%= item.namaRambu %></td><td><%= item.lokasi %></td><td><%= item.jenisRambu %></td><td>A:<%=item.kondisiJelas.jelas_a?'Y':'T'%> B:<%=item.kondisiJelas.jelas_b?'Y':'T'%> C:<%=item.kondisiJelas.jelas_c?'Y':'T'%></td><td>A:<%=item.kondisiPosisi.posisi_a?'Y':'T'%> B:<%=item.kondisiPosisi.posisi_b?'Y':'T'%> C:<%=item.kondisiPosisi.posisi_c?'Y':'T'%></td><td>A:<%=item.kondisiBersih.bersih_a?'Y':'T'%> B:<%=item.kondisiBersih.bersih_b?'Y':'T'%> C:<%=item.kondisiBersih.bersih_c?'Y':'T'%></td><td style="text-align: center; font-weight: bold;"><%= item.totalSkor %></td><td style="text-align: center;"><%= item.hasil %></td><td><%= item.tindakanPerbaikan %></td></tr>
                    <% }); %>
                </tbody>
            </table>
            <table class="key-table" style="width: 80%; margin-left: auto; margin-right: auto;">
                <tr><th>Indikator</th><th>A</th><th>B</th><th>C</th><th>Skor</th><th>Hasil</th></tr>
                <tr><td>Jelas Terbaca</td><td>Tulisan utuh</td><td>Tidak pudar</td><td>Bisa dilihat</td><td>50=3; 30=2; 15=1</td><td rowspan="3" style="vertical-align: middle;">Bagus: >= 80<br>Layak: 65-79<br>Perbaikan: < 65</td></tr>
                <tr><td>Posisi Rambu</td><td>Tepat lokasi</td><td>Tidak bergeser</td><td>Tidak hilang/jatuh</td><td>30=3; 20=2; 10=1</td></tr>
                <tr><td>Kebersihan</td><td>Bersih</td><td>Tidak berdebu</td><td>Tidak berkarat</td><td>20=3; 10=2; 5=1</td></tr>
            </table>

            <div class="final-approval-section">
                <div class="approval-info">
                    <p><strong>Status Approval:</strong> <span class="status status-<%= data.statusLaporan %>"><%= data.statusLaporan ? data.statusLaporan.replace(/_/g,' ') : 'N/A' %></span></p>
                    <% if (data.diperiksaOlehK3_nama) { %><p><strong>Diperiksa Ketua Tim K3:</strong> <%= data.diperiksaOlehK3_nama %> (<%= formatDate(data.tanggalDiperiksaK3) %>)</p><% if (data.catatanK3) { %><p><em>Catatan K3:</em> <%= data.catatanK3 %></p><% } %><% } %>
                    <% if (data.disetujuiOlehTU_nama) { %><p><strong>Disetujui Kabag TU & Umum:</strong> <%= data.disetujuiOlehTU_nama %> (<%= formatDate(data.tanggalDisetujuiTU) %>)</p><% if (data.catatanTU) { %><p><em>Catatan TU:</em> <%= data.catatanTU %></p><% } %><% } %>
                </div>
                <div class="signature-block">
                    <div class="signature-col"><p>Pelaksana / PJ Kegiatan</p><div class="signature-box"></div><p class="signature-name">( <%= data.pelaksana %> )</p></div>
                    <div class="signature-col"><p>Diperiksa</p><div class="signature-box"></div><p class="signature-name">( Ketua Tim K3 )</p></div>
                    <div class="signature-col"><p>Disetujui</p><div class="signature-box"></div><p class="signature-name">( Kabag TU & Umum )</p></div>
                </div>
                <% if (data.statusLaporan === 'Approved_TU') { %>
                    <div class="approval-note">
                        Dokumen ini dianggap sah tanpa memerlukan tanda tangan fisik lebih lanjut setelah memperoleh persetujuan dari Kepala Bagian Tata Usaha dan Umum (Kabag TU & Umum).
                    </div>
                <% } %>
            </div> 
            </div> <% } %> </body>
</html>